<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test OlivIA</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script> <!-- Importation de la biblioth√®que Socket.IO -->
  <style>
    /* D√©finition des styles CSS pour la page */
    .chat-controls {
      margin-top: 10px;
      display: flex;
      align-items: center;
    }
    .toggle-switch {
      margin-left: 20px;
      display: flex;
      align-items: center;
    }
    .toggle-switch label {
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h2>Test OlivIA</h2>
  <div id="chat"></div>
  <div class="chat-controls">
    <input type="text" id="userInput" placeholder="Pose ta question..." style="flex-grow: 1;">
    <button onclick="sendText()">Envoyer</button>
    <div class="toggle-switch">
      <input type="checkbox" id="discussionModeToggle" onchange="toggleDiscussionMode(this.checked)">
      <label for="discussionModeToggle">üéôÔ∏è Mode Discussion</label>
    </div>
  </div>
  
  <script>
    const socket = io("http://localhost:5000");
    let currentOliviaMessageDiv = null;
    let audioQueue = [];
    let isDiscussionModeActive = false;
    let recognition;

    // --- Initialisation ---
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "fr-FR";
      recognition.continuous = false;

      recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        sendQuery(text, true);
      };

      recognition.onend = () => {
        if (isDiscussionModeActive) {
          startRecognition();
        }
      };
      
      recognition.onerror = (event) => {
        console.error("Erreur de reconnaissance vocale :", event.error);
        if (event.error === 'no-speech' && isDiscussionModeActive) {
          startRecognition();
        }
      };
    } else {
      document.querySelector('.toggle-switch').style.display = 'none';
      alert("L'API Web Speech n'est pas support√©e par ce navigateur.");
    }

    // --- Socket Events ---
    socket.on("connect", () => console.log("Connect√© √† Milo"));
    socket.on("text_chunk", (data) => appendMessage("olivia", data.text));
    socket.on("audio_chunk", (data) => audioQueue.push(base64ToBlob(data.audio, `audio/${data.format}`)));
    socket.on("complete", () => {
      console.log("‚úÖ R√©ponse compl√®te.");
      if (audioQueue.length > 0) {
        playAudioQueue();
      } else if (isDiscussionModeActive) {
        startRecognition();
      }
    });

    // --- Fonctions de contr√¥le ---
    function toggleDiscussionMode(isChecked) {
      isDiscussionModeActive = isChecked;
      const label = document.querySelector('label[for="discussionModeToggle"]');
      if (isDiscussionModeActive) {
        label.innerText = "üéôÔ∏è √âcoute en cours...";
        startRecognition();
      } else {
        label.innerText = "üéôÔ∏è Mode Discussion";
        stopRecognition();
      }
    }

    function sendText() {
        const text = document.getElementById("userInput").value;
        sendQuery(text, false);
    }

    function sendQuery(text, useAudioResponse) {
        if (!text) return;
        appendMessage("user", text);
        currentOliviaMessageDiv = null;
        audioQueue = [];

        socket.emit("query", {
            messages: [{ role: "user", content: text }],
            isDiscussionMode: useAudioResponse
        });
        document.getElementById("userInput").value = "";
    }

    // --- Fonctions utilitaires ---
    function startRecognition() {
      if (recognition && isDiscussionModeActive) {
        try {
          recognition.start();
        } catch (e) {
          // Ignore 'InvalidStateError' which happens if it's already running
        }
      }
    }

    function stopRecognition() {
      if (recognition) {
        recognition.stop();
      }
    }

    function playAudioQueue() {
      if (audioQueue.length === 0) return;
      const fullAudioBlob = new Blob(audioQueue, { type: audioQueue[0].type });
      const audioUrl = URL.createObjectURL(fullAudioBlob);
      const audio = new Audio(audioUrl);
      audio.play();
      audio.onended = () => {
        if (isDiscussionModeActive) {
          startRecognition();
        }
      };
    }
    
    function appendMessage(role, text) {
      const chat = document.getElementById("chat");
      if (role === 'user') {
          currentOliviaMessageDiv = null;
          const div = document.createElement("div");
          div.className = `message user`;
          div.innerText = text;
          chat.appendChild(div);
      } else if (role === 'olivia') {
          if (!currentOliviaMessageDiv) {
              currentOliviaMessageDiv = document.createElement("div");
              currentOliviaMessageDiv.className = `message olivia`;
              chat.appendChild(currentOliviaMessageDiv);
          }
          currentOliviaMessageDiv.innerText += text;
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function base64ToBlob(base64, contentType = '') {
      const byteCharacters = atob(base64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: contentType });
    }
  </script>
</body>
</html>